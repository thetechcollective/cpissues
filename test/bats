#!/usr/bin/env bats


#Assume that this is the correct root and that gitconfig is in test folder under root
ROOT_DIR=/workspaces/gh-cpissues
USER=$(gh api user --jq '.login')
path_to_gitconfig=$ROOT_DIR/test/test.gitconfig
DEST_REPO=$(git config --file $path_to_gitconfig setup.dest-repo)

#Please ensure to run this script from the directory that was created in setup.sh to avoid path-related errors.
setup() {
    gh cpissues thetechcollective/gh-cpissues --label testsample
}

@test "CopyCorrectNumberOfIssues" {
    SOURCECOUNT=$(gh issue --repo thetechcollective/gh-cpissues list --label "testsample" --json title --jq 'length')
    TARGETCOUNT=$(gh issue list --json title --jq 'length')
    [ $SOURCECOUNT -eq $TARGETCOUNT ]
}

teardown() {
    delete_issues
}

delete_issues() {
    # List all issue numbers in the repository
    # Uses --repo as safety as to not delete all issues if run from wrong dir.
    ISSUE_NUMBERS=$(gh issue list --repo $USER/$DEST_REPO --json number --jq '.[].number')

    for ISSUE_NUMBER in $ISSUE_NUMBERS; do
        gh issue delete $ISSUE_NUMBER --repo $USER/$DEST_REPO --yes
    done
}